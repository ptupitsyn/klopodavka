<Window x:Class="KlopViewWpf.KlopMainWindow" 
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:KlopViewWpf="clr-namespace:KlopViewWpf" 
        UseLayoutRounding="True"
        xmlns:AttachedCommandBehavior="clr-namespace:AttachedCommandBehavior;assembly=Common" xmlns:Converters="clr-namespace:KlopViewWpf.Converters" xmlns:Controls="clr-namespace:Common.Controls;assembly=Common" xmlns:Controls1="clr-namespace:KlopViewWpf.Controls" Title="Klopodavka 2.0" MinHeight="496" MinWidth="800"    >
    <Window.Resources>
        <ResourceDictionary>
            <Converters:ClopGridWidthConverter x:Key="_clopGridWidthConverter" />
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="Themes\Generic.xaml" />
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Window.Resources>
    <Grid>
        <Grid.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="0.1,1">
                <GradientStop Color="White" Offset="0" />
                <GradientStop Color="LightGray" Offset="1" />
            </LinearGradientBrush>
        </Grid.Background>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        
        <!-- TODO: Popup-based game menu! Center-screen, called by ESC or some button.. with blackjack and hookers -->
        
        <!-- Player Information -->
        <StackPanel Grid.Column="0">
            <KlopViewWpf:PlayerInfo Player="{Binding Model.Players[0]}" Model="{Binding Model}" Margin="10" />
            <KlopViewWpf:PlayerInfo Player="{Binding Model.Players[2]}" Model="{Binding Model}" Margin="10" />
        </StackPanel>

        <StackPanel Grid.Column="2">
            <KlopViewWpf:PlayerInfo Player="{Binding Model.Players[1]}" Model="{Binding Model}" Margin="10" />
            <KlopViewWpf:PlayerInfo Player="{Binding Model.Players[3]}" Model="{Binding Model}" Margin="10" />
        </StackPanel>

        <!-- Game Field -->
        <Border BorderBrush="Gray" BorderThickness="2" Name="gridBorder" Grid.Column="1" CornerRadius="8"
                Controls1:ClippingHelper.ToBounds="True" Margin="0,10,0,10" >
            <Border.Width>
                <MultiBinding Converter="{StaticResource _clopGridWidthConverter}">
                    <Binding RelativeSource="{RelativeSource Self}" Path="ActualHeight" />
                    <Binding Path="Model" />
                </MultiBinding>
            </Border.Width>
            <Border.Background>
                <LinearGradientBrush StartPoint ="0,1" EndPoint ="1,0" Opacity="0.1">
                    <LinearGradientBrush.GradientStops>
                        <GradientStop Color="#FF0000" Offset="0"/>
                        <GradientStop Color="White" Offset="0.5"/>
                        <GradientStop Color="#0000FF" Offset="1"/>
                    </LinearGradientBrush.GradientStops>
                </LinearGradientBrush>
            </Border.Background>
            <ItemsControl ItemsSource="{Binding Model.Cells, IsAsync=True}"                                                  
                          AttachedCommandBehavior:CommandBehavior.Event="MouseRightButtonDown"                                                   
                          AttachedCommandBehavior:CommandBehavior.Command="{Binding UndoCommand}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Rows="{Binding Model.FieldHeight}" Columns="{Binding Model.FieldWidth}">
                            <UniformGrid.Background>
                                <ImageBrush Opacity="0.1">
                                    <ImageBrush.ImageSource>
                                        <BitmapImage UriSource="Images\Bedbug.png" />
                                    </ImageBrush.ImageSource>
                                </ImageBrush>
                            </UniformGrid.Background>
                        </UniformGrid>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!--<Border Background="{Binding Owner.Color, Converter={StaticResource _colorToKlopBrushConverter}}" />-->
                        <KlopViewWpf:KlopCell2 Model="{Binding RelativeSource={RelativeSource AncestorType=Window}, Path=DataContext.Model}"  
                                               Cell="{Binding}" 
                                               MouseLeftButtonUp="KlopCell_MouseLeftButtonUp"
                                               MouseEnter="KlopCell_MouseEnter"
                                               />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Border>
        
        <!-- Test buttons -->
        <StackPanel Orientation="Vertical" VerticalAlignment="Bottom" HorizontalAlignment="Left" Margin="10" >
            <Controls:ImageLinkButton Content="Reset" Command="{Binding ResetCommand}" Foreground="Blue"  ActiveForeground="Blue" Cursor="Hand" />
            <!--<Controls:ImageLinkButton Content="Init" Click="ImageLinkButton_Click" Foreground="Blue"  ActiveForeground="Blue" Cursor="Hand" />-->
        </StackPanel>
    </Grid>
</Window>
